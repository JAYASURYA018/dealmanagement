<div class="min-h-screen bg-[#eff2f9] flex flex-col p-4 md:p-6 font-sans gap-4 relative">

    <!-- Loading Overlay -->
    <div *ngIf="isLoading"
        class="absolute inset-0 bg-white/80 z-50 flex items-center justify-center rounded-xl backdrop-blur-sm">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
            <p class="text-gray-500 font-medium">Loading quote details...</p>
        </div>
    </div>

    <!-- Main Content (Hidden while loading to prevent flicker) -->
    <div [class.opacity-0]="isLoading" class="flex flex-col gap-4 transition-opacity duration-300">

        <!-- 1. Header Card (Full Width) -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <!-- Top Row: Logo & Opportunity -->
            <div class="flex justify-between items-start mb-6">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-blue-100 rounded flex items-center justify-center text-blue-600">
                        <span class="material-icons-outlined">apartment</span>
                    </div>
                    <div>
                        <h2 class="text-lg font-bold text-gray-900">{{ accountName }}</h2>
                        <p class="text-xs text-gray-500">{{ website }}</p>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-xs text-gray-500">Opportunity</div>
                    <div class="text-sm font-medium text-gray-900">{{ opportunityName }}</div>
                </div>
            </div>

            <!-- Bottom Row: Quote Selector & Actions -->
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <button
                        class="px-4 py-2 bg-blue-50 text-slate-700 rounded-lg text-sm font-semibold hover:bg-blue-100 transition-colors shadow-sm">
                        Quote 1
                    </button>
                    <button
                        class="w-8 h-8 flex items-center justify-center text-gray-400 hover:bg-gray-100 rounded-full transition-colors font-bold">
                        <span class="material-icons-outlined text-lg">add</span>
                    </button>
                </div>
                <div class="flex space-x-3">
                    <button
                        class="px-5 py-2 bg-white text-slate-700 rounded-full text-sm font-semibold hover:bg-gray-50 shadow-sm flex items-center transition-colors border border-blue-600">
                        <span class="material-icons-outlined text-lg mr-2 text-slate-700">person</span>
                        Preview approval
                    </button>


                    <!-- Create contract button - always visible, but no action for subscription flow -->
                    <button (click)="!isLookerSubscription ? onSave() : null" [disabled]="isSaving"
                        [class.opacity-50]="isSaving"
                        class="px-5 py-2 bg-blue-50 text-slate-700 rounded-full text-sm font-semibold shadow-sm flex items-center transition-colors border border-blue-100"
                        [class.hover:bg-blue-100]="!isLookerSubscription" [class.cursor-default]="isLookerSubscription">
                        <span class="material-icons-outlined text-lg mr-2 text-slate-700">feed</span>
                        <span *ngIf="!isSaving">Create contract</span>
                        <span *ngIf="isSaving">Creating...</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- 2. Content Area (Grid/Flex) -->
        <div class="flex flex-col lg:flex-row gap-4 items-start">

            <!-- Content Card: Product Info + Form -->
            <div class="flex-1 bg-white rounded-xl shadow-sm border border-gray-200 p-6 w-full">
                <!-- Product Header -->
                <div class="mb-6">
                    <div class="flex justify-between items-start mb-6">
                        <div class="flex items-center gap-3">

                            <div>
                                <div class="text-xs text-gray-500 mb-0.5">{{ quoteId }}</div>
                                <h3 class="text-lg font-bold text-gray-800">{{ productName }}</h3>
                            </div>
                        </div>

                        <div class="flex items-start gap-8 text-left">
                            <div>
                                <div class="text-xs text-gray-500 mb-1">Contract Start Date</div>
                                <div class="text-sm font-medium text-gray-900">Upon provisioning</div>
                            </div>
                            <div>
                                <div class="text-xs text-gray-500 mb-1">Term</div>
                                <div class="text-sm font-medium text-gray-900">{{ totalTerms }} months</div>
                            </div>
                            <div>
                                <div class="text-xs text-gray-500 mb-1">Total Contract Value</div>
                                <div class="text-sm font-medium text-gray-900">{{ formatCurrency(totalContractValue) }}
                                </div>
                            </div>
                            <button class="text-gray-400 hover:text-gray-600">
                                <span class="material-icons-outlined text-xl">more_vert</span>
                            </button>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <div class="flex border-b border-gray-200 mb-6">
                        <button (click)="switchTab('details')"
                            class="pb-2 px-1 text-sm font-medium mr-6 transition-colors border-b-2"
                            [ngClass]="activeTab === 'details' ? 'text-blue-600 border-blue-600' : 'text-gray-500 border-transparent hover:text-gray-700'">
                            Details
                        </button>
                        <button (click)="switchTab('discounts')"
                            class="pb-2 px-1 text-sm font-medium transition-colors border-b-2 hover:text-gray-700"
                            [ngClass]="activeTab === 'discounts' ? 'text-blue-600 border-blue-600' : 'text-gray-500 border-transparent'">
                            {{ isLookerSubscription ? 'Plans & Discounts' : 'Discounts and Incentives' }}
                        </button>
                    </div>
                </div>

                <!-- Discounts/Plans Tab Content -->
                <div *ngIf="activeTab === 'discounts'" class="w-full">
                    <app-discounts-incentives *ngIf="!isLookerSubscription" [productId]="productId"
                        [parentQuoteLineId]="bundleQuoteLineId"></app-discounts-incentives>

                    <!-- Looker Subscription Flow -->
                    <div *ngIf="isLookerSubscription"
                        class="grid grid-cols-1 lg:grid-cols-12 gap-8 animate-in fade-in duration-300">
                        <div class="col-span-12">
                            <!-- Header with Subscription Periods and Dates -->
                            <div class="flex justify-between items-center mb-10">
                                <h4 class="text-gray-800 text-[20px] font-medium">Subscription Periods</h4>

                                <div class="flex gap-4">
                                    <!-- Subscription Start Date -->
                                    <div
                                        class="bg-white p-2 rounded-lg border border-gray-300 hover:border-gray-400 transition-colors relative group h-[52px] flex flex-col justify-center min-w-[240px]">
                                        <label class="block text-[12px] text-gray-600 mb-0.5 leading-none">Subscription
                                            Start
                                            Date</label>
                                        <div class="relative w-full flex items-center">
                                            <input type="date" [(ngModel)]="termStartInput" [min]="minDate"
                                                (ngModelChange)="updateExpirationDate()"
                                                class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"
                                                placeholder="Select">
                                            <div class="text-sm font-medium text-gray-900 leading-tight">
                                                {{ termStartInput ? (termStartInput | date:'mediumDate') : 'Select' }}
                                            </div>
                                            <span
                                                class="material-icons-outlined text-gray-600 text-lg ml-auto pointer-events-none">calendar_today</span>
                                        </div>
                                    </div>
                                    <!-- Subscription End Date -->
                                    <div
                                        class="bg-white p-2 rounded-lg border border-gray-300 hover:border-gray-400 transition-colors relative group h-[52px] flex flex-col justify-center min-w-[240px]">
                                        <label class="block text-[12px] text-gray-600 mb-0.5 leading-none">Subscription
                                            End
                                            Date</label>
                                        <div class="relative w-full flex items-center">
                                            <input type="date" [(ngModel)]="termEndDate"
                                                [min]="termStartInput || minDate"
                                                (ngModelChange)="updateTermFromDates()"
                                                class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"
                                                placeholder="Select">
                                            <div class="text-sm font-medium text-gray-900 leading-tight">
                                                {{ termEndDate ? (termEndDate | date:'mediumDate') : 'Select' }}
                                            </div>
                                            <span
                                                class="material-icons-outlined text-gray-600 text-lg ml-auto pointer-events-none">calendar_today</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Empty State -->
                            <div *ngIf="subscriptionPeriods.length === 0"
                                class="flex flex-col items-center justify-center py-16 bg-slate-100 rounded-xl">
                                <button (click)="openSubscriptionModal()"
                                    class="flex items-center gap-2 px-6 py-2.5 bg-blue-600 rounded-full transition-colors shadow-sm mb-3 text-white">
                                    <div
                                        class="w-5 h-5 text-white rounded-full flex items-center justify-center flex-shrink-0">
                                        <span class="text-[20px] font-medium pb-1">+</span>
                                    </div>
                                    <span class="text-[14px] font-medium">Create Subscription Periods</span>
                                </button>
                                <p class="text-[14px] font-medium text-gray-600">
                                    You can choose to create yearly or a custom period
                                </p>
                            </div>

                            <!-- Subscription Periods List -->
                            <div *ngIf="subscriptionPeriods.length > 0"
                                class="space-y-4 animate-in fade-in duration-500">
                                <app-subscription-period-item *ngFor="let period of subscriptionPeriods"
                                    [period]="period" [products]="productOptions" [regionOptions]="lookerRegionOptions">
                                </app-subscription-period-item>

                                <!-- Add Period Button at Bottom -->
                                <div class="mt-6 flex justify-start">
                                    <button (click)="openSubscriptionModal()"
                                        class="flex items-center gap-2 text-blue-600 font-semibold hover:text-blue-700 transition-colors group p-3">
                                        <div
                                            class="w-6 h-6 bg-blue-600 rounded-full flex items-center justify-center text-white group-hover:bg-blue-700 transition-colors">
                                            <span class="material-icons-outlined text-sm font-semibold">add</span>
                                        </div>
                                        <span class="text-sm">Add Period</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Grid Layout: 9 Columns (Forms) | 3 Columns (Payment) -->
                <div *ngIf="activeTab === 'details'" class="grid grid-cols-1 lg:grid-cols-12 gap-8">

                    <!-- Left Side: Forms & Commitment (Span 9) -->
                    <div class="col-span-12 lg:col-span-9">

                        <!-- STANDARD LAYOUT (Existing) -->
                        <ng-container *ngIf="!isLookerSubscription">
                            <!-- Form Grid -->
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                                <!-- Primary Contact (Professional Dropdown) -->
                                <div (click)="primaryContactOpen = !primaryContactOpen"
                                    class="bg-slate-200 p-2 rounded-lg border-b-2 border-transparent hover:bg-slate-300 transition-colors relative group h-[52px] flex items-center cursor-pointer">
                                    <div
                                        class="w-8 h-8 rounded-full bg-white flex-shrink-0 mr-3 shadow-sm flex items-center justify-center">
                                        <span class="material-icons-outlined text-gray-400 text-lg">person</span>
                                    </div>
                                    <div class="flex-1 flex flex-col justify-center">
                                        <label class="block text-[11px] text-gray-600 mb-0.5 leading-none">Primary
                                            contact</label>
                                        <div class="text-sm font-medium text-gray-900 leading-tight">{{
                                            primaryContactName
                                            ||
                                            'Select' }}</div>
                                    </div>
                                    <span class="material-icons-outlined text-base text-gray-500">arrow_drop_down</span>

                                    <!-- Custom Dropdown List -->
                                    <div *ngIf="primaryContactOpen" (click)="$event.stopPropagation()"
                                        class="absolute left-0 top-[56px] w-full bg-white rounded-lg shadow-xl border border-gray-100 z-[100] py-2">
                                        <button *ngFor="let contact of primaryContactOptions"
                                            (click)="selectContact(contact)"
                                            class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-blue-50 transition-colors">
                                            {{ contact }}
                                        </button>
                                    </div>
                                </div>

                                <!-- Sales Channel (Professional Dropdown) -->
                                <div (click)="salesChannelOpen = !salesChannelOpen"
                                    class="bg-slate-200 p-2 rounded-lg border-b-2 border-transparent hover:bg-slate-300 transition-colors relative group h-[52px] flex flex-col justify-center cursor-pointer">
                                    <label class="block text-[11px] text-gray-600 mb-0.5 leading-none">Sales
                                        Channel</label>
                                    <div class="text-sm font-medium text-gray-900">{{ salesChannel || 'Select' }}</div>
                                    <span
                                        class="material-icons-outlined text-base absolute right-2 bottom-3 text-gray-500">arrow_drop_down</span>

                                    <!-- Custom Dropdown List -->
                                    <div *ngIf="salesChannelOpen" (click)="$event.stopPropagation()"
                                        class="absolute left-0 top-[56px] w-full bg-white rounded-lg shadow-xl border border-gray-100 z-[100] py-2">
                                        <button *ngFor="let channel of salesChannelOptions"
                                            (click)="selectChannel(channel)"
                                            class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-blue-50 transition-colors">
                                            {{ channel }}
                                        </button>
                                    </div>
                                </div>
                                <!-- Start Date -->
                                <div
                                    class="bg-slate-200 p-2 rounded-lg border-b-2 border-transparent hover:bg-slate-300 transition-colors relative group h-[52px] flex flex-col justify-center">
                                    <label class="block text-[11px] text-gray-600 mb-0.5">Quote Start date</label>
                                    <input type="date" [(ngModel)]="startDate" (ngModelChange)="updateExpirationDate()"
                                        [min]="minDate"
                                        class="w-full bg-transparent text-sm text-gray-800 outline-none cursor-pointer font-medium -mt-0.5"
                                        placeholder="Select">
                                </div>
                                <!-- Expiration Date -->
                                <div
                                    class="bg-slate-200 p-2 rounded-lg border-b-2 border-transparent hover:bg-slate-300 transition-colors relative group h-[52px] flex flex-col justify-center">
                                    <label class="block text-[11px] text-gray-600 mb-0.5">Quote Expiration date</label>
                                    <input type="date" [(ngModel)]="expirationDate" [readOnly]="true"
                                        class="w-full bg-transparent text-sm text-gray-800 outline-none font-medium -mt-0.5 cursor-not-allowed"
                                        placeholder="-">
                                </div>
                            </div>

                            <!-- Commitment Period -->
                            <div *ngIf="!isLookerSubscription">
                                <div class="flex justify-between items-center mb-6">
                                    <h4 class="text-gray-800 text-lg font-medium">Total commitment period</h4>
                                    <div class="flex items-center space-x-4">
                                        <button (click)="removePeriod()" [disabled]="commitmentPeriods.length <= 1"
                                            [class.opacity-50]="commitmentPeriods.length <= 1"
                                            class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center hover:bg-blue-200 transition-colors">
                                            <span class="material-icons-outlined text-base">remove</span>
                                        </button>
                                        <span class="text-lg font-medium text-gray-900 w-4 text-center">{{
                                            commitmentPeriods.length }}</span>
                                        <button (click)="addPeriod()" [disabled]="commitmentPeriods.length >= 5"
                                            [class.opacity-50]="commitmentPeriods.length >= 5"
                                            class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center hover:bg-blue-200 transition-colors">
                                            <span class="material-icons-outlined text-base">add</span>
                                        </button>
                                    </div>
                                </div>

                                <!-- Dynamic Cards Loop -->
                                <div class="space-y-4">
                                    <div *ngFor="let period of commitmentPeriods; let i = index">

                                        <!-- VIEW MODE (Collapsed) -->
                                        <div *ngIf="period.isCollapsed" (click)="toggleEdit(i)"
                                            class="bg-gray-100 border border-transparent hover:border-gray-200 rounded-xl p-4 flex justify-between items-center cursor-pointer transition-colors mb-2">
                                            <h5 class="text-sm font-bold text-gray-800 flex items-center">
                                                Commit Period {{ i + 1 }}
                                                <span *ngIf="period.isDuplicated"
                                                    class="ml-2 bg-gray-200 text-gray-600 text-[10px] px-2 py-0.5 rounded-full font-bold">Duplicated</span>
                                            </h5>
                                            <div class="flex items-center space-x-3">
                                                <span
                                                    class="bg-sky-200 text-sky-900 w-24 px-3 py-1.5 rounded-md text-xs font-bold text-center inline-block">{{
                                                    period.months }} months</span>
                                                <span
                                                    class="bg-sky-200 text-sky-900 min-w-[140px] px-3 py-1.5 rounded-md text-xs font-bold text-center inline-block">{{
                                                    formatCurrency(period.amount) }}</span>

                                                <!-- Configuration Menu (Collapsed) -->
                                                <div class="relative">
                                                    <button (click)="toggleMenu(i, $event)"
                                                        class="text-gray-400 hover:text-gray-600 p-1 rounded-full hover:bg-gray-200 transition-colors">
                                                        <span class="material-icons-outlined text-base">more_vert</span>
                                                    </button>

                                                    <!-- Menu Dropdown -->
                                                    <div *ngIf="activeMenuIndex === i"
                                                        (click)="$event.stopPropagation()"
                                                        class="absolute right-0 top-8 w-40 bg-white rounded-lg shadow-xl border border-gray-100 z-50 py-2 overflow-hidden">
                                                        <button (click)="duplicatePeriod(i)"
                                                            class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center space-x-2 transition-colors">
                                                            <span
                                                                class="material-icons-outlined text-gray-400 text-[18px]">content_copy</span>
                                                            <span>Duplicate</span>
                                                        </button>
                                                        <button (click)="deletePeriod(i)"
                                                            class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center space-x-2 transition-colors">
                                                            <span
                                                                class="material-icons-outlined text-gray-400 text-[18px]">delete</span>
                                                            <span>Delete</span>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- EDIT MODE (Expanded) -->
                                        <div *ngIf="!period.isCollapsed" (focusout)="checkCollapse(i, $event)"
                                            class="bg-gray-50 border border-gray-200 rounded-xl p-6" tabindex="-1">
                                            <div class="flex justify-between items-center mb-4">
                                                <h5 class="text-sm font-bold text-gray-800 flex items-center">
                                                    Commit Period {{ i + 1 }}
                                                    <!-- <span *ngIf="period.isDuplicated"
                                                    class="ml-2 bg-gray-200 text-gray-600 text-[10px] px-2 py-0.5 rounded-full font-bold">Duplicated</span> -->
                                                </h5>
                                                <div class="relative">
                                                    <button (click)="toggleMenu(i, $event)"
                                                        class="text-gray-400 hover:text-gray-600 rounded-full hover:bg-gray-100 p-1 transition-colors">
                                                        <span class="material-icons-outlined text-base">more_vert</span>
                                                    </button>

                                                    <!-- Menu Dropdown -->
                                                    <div *ngIf="activeMenuIndex === i"
                                                        (click)="$event.stopPropagation()"
                                                        class="absolute right-0 top-8 w-40 bg-white rounded-lg shadow-xl border border-gray-100 z-50 py-2 overflow-hidden">
                                                        <button (click)="duplicatePeriod(i)"
                                                            class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center space-x-2 transition-colors">
                                                            <span
                                                                class="material-icons-outlined text-gray-400 text-[18px]">content_copy</span>
                                                            <span>Duplicate</span>
                                                        </button>
                                                        <button (click)="deletePeriod(i)"
                                                            class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center space-x-2 transition-colors">
                                                            <span
                                                                class="material-icons-outlined text-gray-400 text-[18px]">delete</span>
                                                            <span>Delete</span>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="grid grid-cols-2 gap-4">
                                                <!-- Period Input -->
                                                <div>
                                                    <div
                                                        class="bg-gray-100 p-2 rounded-lg border-b-2 border-transparent hover:bg-gray-200 transition-colors relative group h-[52px] flex flex-col justify-center focus-within:ring-1 focus-within:ring-blue-500">
                                                        <label class="block text-[11px] text-gray-600 mb-0.5">Period
                                                            (months)</label>
                                                        <input #monthsInput type="text" placeholder="Enter"
                                                            (keydown)="restrictNumeric($event)"
                                                            [value]="period.months ? period.months + ' months' : ''"
                                                            (focus)="onMonthFocus(i, monthsInput)"
                                                            (blur)="onMonthBlur(i, monthsInput)"
                                                            (input)="onMonthInput(i, monthsInput.value)"
                                                            (keydown.enter)="handleInputEnter(i, 'months', $event, monthsInput, amountInput)"
                                                            class="w-full bg-transparent text-sm text-gray-800 outline-none font-medium -mt-0.5 placeholder-gray-400">
                                                    </div>
                                                </div>

                                                <!-- Amount Input -->
                                                <div
                                                    class="bg-gray-100 p-2 rounded-lg border-b-2 border-transparent hover:bg-gray-200 transition-colors relative group h-[52px] flex flex-col justify-center focus-within:ring-1 focus-within:ring-blue-500">
                                                    <label class="block text-[11px] text-gray-600 mb-0.5">Amount</label>
                                                    <input #amountInput type="text" placeholder="Enter"
                                                        (keydown)="restrictNumeric($event)"
                                                        [value]="period.amount ? formatCurrency(period.amount).replace('$', '') : ''"
                                                        (blur)="onAmountBlur(i, amountInput.value)"
                                                        (keydown.enter)="handleInputEnter(i, 'amount', $event, monthsInput, amountInput)"
                                                        class="w-full bg-transparent text-sm text-gray-800 outline-none font-medium -mt-0.5 placeholder-gray-400">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Add Commit Period Button -->
                                <div class="mt-4">
                                    <button (click)="addPeriod()" [disabled]="commitmentPeriods.length >= 5"
                                        [class.opacity-50]="commitmentPeriods.length >= 5"
                                        class="flex items-center text-blue-600 hover:text-blue-700 font-semibold text-sm transition-colors">
                                        <span class="material-icons-outlined mr-2">add</span>
                                        Add Commit Period
                                    </button>
                                </div>
                            </div>
                        </ng-container>

                        <!-- SUBSCRIPTION FLOW LAYOUT (Looker New RCA) -->
                        <ng-container *ngIf="isLookerSubscription">
                            <!-- QUOTE DETAILS SECTION -->
                            <h4 class="text-gray-800 text-base font-bold mb-3">Quote details</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                                <!-- Primary Contact -->
                                <div (click)="togglePrimaryContact(); $event.stopPropagation()"
                                    class="bg-gray-100 p-2 rounded-lg border-b-2 border-transparent hover:bg-gray-200 transition-colors relative group h-[52px] flex items-center cursor-pointer">
                                    <!-- <div class="w-8 h-8 rounded-full overflow-hidden flex-shrink-0 mr-2">
                                       
                                        <img src="https://ui-avatars.com/api/?name={{primaryContactName || 'User'}}&background=random"
                                            alt="" class="w-full h-full object-cover">
                                    </div> -->
                                    <div
                                        class="w-8 h-8 rounded-full bg-white flex-shrink-0 mr-3 shadow-sm flex items-center justify-center">
                                        <span class="material-icons-outlined text-gray-400 text-lg">person</span>
                                    </div>
                                    <div class="flex-1 flex flex-col justify-center">
                                        <label
                                            class="block text-[10px] text-gray-500 mb-0.5 uppercase tracking-wide font-medium">Primary
                                            contact</label>
                                        <div class="text-sm font-medium text-gray-900 leading-tight truncate">{{
                                            primaryContactName ||
                                            'Select' }}</div>
                                    </div>
                                    <div *ngIf="primaryContactOpen" (click)="$event.stopPropagation()"
                                        class="absolute left-0 top-[56px] w-full bg-white rounded-lg shadow-xl border border-gray-100 z-[100] py-2">
                                        <button *ngFor="let contact of primaryContactOptions"
                                            (click)="selectContact(contact)"
                                            class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-blue-50 transition-colors">
                                            {{ contact }}
                                        </button>
                                    </div>
                                </div>

                                <!-- Sales Channel -->
                                <div (click)="toggleSalesChannel(); $event.stopPropagation()"
                                    class="bg-gray-100 p-2 rounded-lg border-b-2 border-transparent hover:bg-gray-200 transition-colors relative group h-[52px] flex flex-col justify-center cursor-pointer">
                                    <label
                                        class="block text-[10px] text-gray-500 mb-0.5 uppercase tracking-wide font-medium">Sales
                                        Channel</label>
                                    <div class="flex justify-between items-center">
                                        <div class="text-sm font-medium text-gray-900">{{ salesChannel || 'Select' }}
                                        </div>
                                        <span
                                            class="material-icons-outlined text-sm text-gray-400">arrow_drop_down</span>
                                    </div>
                                    <div *ngIf="salesChannelOpen" (click)="$event.stopPropagation()"
                                        class="absolute left-0 top-[60px] w-full bg-white rounded-lg shadow-xl border border-gray-100 z-[100] py-2">
                                        <button *ngFor="let channel of salesChannelOptions"
                                            (click)="selectChannel(channel)"
                                            class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-blue-50 transition-colors">
                                            {{ channel }}
                                        </button>
                                    </div>
                                </div>

                                <!-- Operation Type -->
                                <div (click)="toggleOperationType(); $event.stopPropagation()"
                                    class="bg-gray-100 p-2 rounded-lg border-b-2 border-transparent hover:bg-gray-200 transition-colors relative group h-[52px] flex flex-col justify-center cursor-pointer">
                                    <label
                                        class="block text-[10px] text-gray-500 mb-0.5 uppercase tracking-wide font-medium">Operation
                                        Type</label>
                                    <div class="flex justify-between items-center">
                                        <div class="text-sm font-medium text-gray-900">{{ operationType || 'Select' }}
                                        </div>
                                        <span
                                            class="material-icons-outlined text-sm text-gray-400">arrow_drop_down</span>
                                    </div>
                                    <div *ngIf="operationTypeOpen" (click)="$event.stopPropagation()"
                                        class="absolute left-0 top-[60px] w-full bg-white rounded-lg shadow-xl border border-gray-100 z-[100] py-2">
                                        <button *ngFor="let type of operationTypeOptions"
                                            (click)="selectOperationType(type)"
                                            class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-blue-50 transition-colors">
                                            {{ type }}
                                        </button>
                                    </div>
                                </div>

                                <!-- Quote Expiration Date -->
                                <div
                                    class="bg-gray-100 p-2 rounded-lg border-b-2 border-transparent hover:bg-gray-200 transition-colors relative group h-[52px] flex flex-col justify-center">
                                    <label
                                        class="block text-[10px] text-gray-500 mb-0.5 uppercase tracking-wide font-medium">Quote
                                        Expiration Date</label>
                                    <div class="flex justify-between items-center w-full relative">
                                        <input type="date" [(ngModel)]="expirationDate"
                                            class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"
                                            placeholder="Select">
                                        <div class="text-sm font-medium text-gray-900 leading-tight">
                                            {{ formatDate(expirationDate) || 'Select' }}
                                        </div>
                                        <span
                                            class="material-icons-outlined text-gray-600 text-lg ml-auto pointer-events-none">calendar_today</span>
                                    </div>
                                </div>
                            </div>

                            <!-- SUBSCRIPTION DETAILS SECTION -->
                            <h4 class="text-gray-800 text-base font-bold mb-3">Subscription details</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                                <!-- Billing Frequency -->
                                <div (click)="toggleBillingFrequency(); $event.stopPropagation()"
                                    class="bg-gray-100 p-2 rounded-lg border-b-2 border-transparent hover:bg-gray-200 transition-colors relative group h-[52px] flex flex-col justify-center cursor-pointer">
                                    <label
                                        class="block text-[10px] text-gray-500 mb-0.5 uppercase tracking-wide font-medium">Billing
                                        Frequency</label>
                                    <div class="flex justify-between items-center">
                                        <div class="text-sm font-medium text-gray-900 truncate">{{ billingFrequency ||
                                            'Select' }}</div>
                                        <span
                                            class="material-icons-outlined text-sm text-gray-400">arrow_drop_down</span>
                                    </div>
                                    <div *ngIf="billingFrequencyOpen" (click)="$event.stopPropagation()"
                                        class="absolute left-0 top-[60px] w-full bg-white rounded-lg shadow-xl border border-gray-100 z-[100] py-2 max-h-[200px] overflow-y-auto slim-scrollbar">
                                        <button *ngFor="let freq of billingFrequencyOptions"
                                            (click)="selectBillingFrequency(freq)"
                                            class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-blue-50 transition-colors">
                                            {{ freq }}
                                        </button>
                                    </div>
                                </div>

                                <!-- Term Starts on -->
                                <div (click)="toggleTermStartsOn(); $event.stopPropagation()"
                                    class="bg-gray-100 p-2 rounded-lg border-b-2 border-transparent hover:bg-gray-200 transition-colors relative group h-[52px] flex flex-col justify-center cursor-pointer">
                                    <label
                                        class="block text-[10px] text-gray-500 mb-0.5 uppercase tracking-wide font-medium">Term
                                        Starts on</label>
                                    <div class="flex justify-between items-center">
                                        <div class="text-sm font-medium text-gray-900 truncate">{{ termStartsOn ||
                                            'Select'
                                            }}</div>
                                        <span
                                            class="material-icons-outlined text-sm text-gray-400">arrow_drop_down</span>
                                    </div>
                                    <div *ngIf="termStartsOnOpen" (click)="$event.stopPropagation()"
                                        class="absolute left-0 top-[60px] w-full bg-white rounded-lg shadow-xl border border-gray-100 z-[100] py-2">
                                        <button *ngFor="let start of termStartsOnOptions"
                                            (click)="selectTermStartsOn(start)"
                                            class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-blue-50 transition-colors">
                                            {{ start }}
                                        </button>
                                    </div>
                                </div>

                                <!-- Term Start Date -->
                                <div [class.opacity-50]="isTermStartDateDisabled()"
                                    [class.cursor-not-allowed]="isTermStartDateDisabled()"
                                    class="bg-gray-100 p-2 rounded-lg border-b-2 border-transparent hover:bg-gray-200 transition-colors relative group h-[52px] flex flex-col justify-center">
                                    <label
                                        class="block text-[10px] text-gray-500 mb-0.5 uppercase tracking-wide font-medium">Term
                                        Start Date</label>
                                    <div class="flex justify-between items-center w-full relative">
                                        <input type="date" [(ngModel)]="termStartDate"
                                            (ngModelChange)="updateExpirationDate()" [min]="minDate"
                                            [disabled]="isTermStartDateDisabled()"
                                            class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10 disabled:cursor-not-allowed"
                                            placeholder="Select">
                                        <div class="text-sm font-medium text-gray-900 leading-tight">
                                            {{ formatDate(termStartDate) || 'Select' }}
                                        </div>
                                        <span
                                            class="material-icons-outlined text-gray-600 text-lg ml-auto pointer-events-none">calendar_today</span>
                                    </div>
                                </div>

                                <!-- Term End Date -->
                                <div
                                    class="bg-gray-100 p-2 rounded-lg border-b-2 border-transparent hover:bg-gray-200 transition-colors relative group h-[52px] flex flex-col justify-center">
                                    <label
                                        class="block text-[10px] text-gray-500 mb-0.5 uppercase tracking-wide font-medium">Term
                                        End Date</label>
                                    <div class="flex justify-between items-center w-full relative">
                                        <input type="date" [(ngModel)]="termEndDate"
                                            (ngModelChange)="updateTermFromDates()" [min]="termStartDate || minDate"
                                            class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"
                                            placeholder="Select">
                                        <div class="text-sm font-medium text-gray-900 leading-tight">
                                            {{ formatDate(termEndDate) || 'Select' }}
                                        </div>
                                        <span
                                            class="material-icons-outlined text-gray-600 text-lg ml-auto pointer-events-none">calendar_today</span>
                                    </div>
                                </div>
                            </div>
                        </ng-container>

                    </div>

                    <!-- Right Side: Payment Account (Span 3) -->
                    <div class="col-span-12 lg:col-span-3">
                        <div class="bg-white rounded-lg border border-gray-200 p-5 h-full max-h-[380px]">
                            <div class="flex justify-between items-start mb-4">
                                <h3 class="font-bold text-gray-900 text-sm">Payment Account</h3>
                                <button class="text-gray-400 hover:text-gray-600 p-1">
                                    <span class="material-icons-outlined text-[16px]">edit</span>
                                </button>
                            </div>

                            <div class="space-y-4">
                                <div>
                                    <div
                                        class="bg-gray-200 text-gray-600 text-[10px] px-2 py-0.5 rounded-full inline-block mb-1 font-bold">
                                        Primary</div>
                                    <div class="text-sm font-medium text-gray-900">XXX XXXXXX</div>
                                </div>
                                <div>
                                    <div class="text-[11px] text-gray-500 mb-0.5">Billing Account</div>
                                    <div class="text-sm font-medium text-gray-900">XXXXXX-XXXXXX-XXXXXX</div>
                                </div>
                                <div>
                                    <div class="text-[11px] text-gray-500 mb-0.5">Payment Account ID</div>
                                    <div class="text-sm font-medium text-gray-900">XXXXXX-XXXXXX-XXXXXXX</div>
                                </div>
                                <div>
                                    <div class="text-[11px] text-gray-500 mb-0.5">Billing Address</div>
                                    <div class="text-sm font-medium text-gray-900">5920 Niagara River Parkway<br>Niagara
                                        Falls ON L2E 6X8 CA</div>
                                </div>
                                <div>
                                    <div class="text-[11px] text-gray-500 mb-0.5">Billing Currency</div>
                                    <div class="text-sm font-medium text-gray-900">CAD</div>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer Card -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 flex justify-end gap-3 items-center">
            <button (click)="openPreview()"
                class="px-6 py-2 rounded-full text-sm font-bold border border-blue-300 text-blue-700 hover:bg-blue-50 transition-colors bg-blue-50 shadow-sm">
                Preview
            </button>
            <button (click)="onSkipAndSave()"
                class="px-6 py-2 rounded-full text-sm font-bold border border-gray-200 text-gray-700 hover:bg-gray-50 transition-colors bg-white shadow-sm">
                Skip & Save
            </button>

            <button (click)="resetForm()"
                class="px-6 py-2 rounded-full text-sm font-bold border border-gray-200 text-gray-700 hover:bg-gray-50 transition-colors bg-white shadow-sm">
                Cancel
            </button>
            <button (click)="resetForm()"
                class="px-6 py-2 rounded-full text-sm font-bold border border-gray-200 text-gray-700 hover:bg-gray-50 transition-colors bg-white shadow-sm">
                Skip
            </button>
            <button (click)="submitQuote()"
                class="px-8 py-2 rounded-full text-sm font-bold bg-[#e8eaed] text-[#3c4043] hover:bg-gray-300 transition-colors shadow-sm">
                Submit
            </button>
        </div>

        <!-- Subscription Periods Modal Component -->
        <app-subscription-periods-modal [isOpen]="isSubscriptionModalOpen" (close)="closeSubscriptionModal()"
            (create)="onSubscriptionPeriodsCreated($event)">
        </app-subscription-periods-modal>

    </div>

    <!-- Success Popup Modal -->
    <div *ngIf="showSuccessPopup"
        class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
        <div
            class="bg-white rounded-2xl shadow-2xl p-8 max-w-sm w-full text-center transform transition-all scale-100 relative">
            <button (click)="closePopup()"
                class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors">
                <span class="material-icons-outlined text-xl">close</span>
            </button>

            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <span class="material-icons-outlined text-3xl text-green-600">check_circle</span>
            </div>
            <h3 class="text-xl font-bold text-gray-900 mb-2">Quote Created!</h3>
            <p class="text-gray-500 mb-2">The quote has been successfully created and saved to the system.</p>
            <p class="text-lg font-bold text-blue-600 mb-6">{{ quoteId }}</p>

            <a *ngIf="salesforceQuoteId"
                [href]="'https://vector--rcaagivant.sandbox.lightning.force.com/lightning/r/Quote/' + salesforceQuoteId + '/view'"
                target="_blank" class="text-sm text-blue-500 hover:text-blue-700 underline block mb-4">
                View in Salesforce
            </a>

            <!-- Screenshot Preview -->
            <div *ngIf="false" class="mt-6 border-t pt-6">
                <h4 class="text-sm font-semibold text-gray-700 mb-3">Quote Preview</h4>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <img [src]="previewScreenshot" alt="Quote Preview Screenshot"
                        class="w-full h-auto rounded shadow-lg">
                </div>
            </div>
        </div>
    </div>

    <!-- Quote Preview Popup Modal -->
    <div *ngIf="showPreviewPopup"
        [ngClass]="isCapturingScreenshot ? 'fixed -left-[9999px] top-0 z-50' : 'fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm'">
        <div
            class="bg-white rounded-2xl shadow-2xl max-w-7xl w-full mx-4 transform transition-all scale-100 relative max-h-[90vh] overflow-y-auto">
            <!-- Header with Close Button -->
            <div
                class="sticky top-0 bg-white border-b border-gray-300 px-8 py-4 rounded-t-2xl flex justify-between items-center z-10">
                <h2 class="text-2xl font-bold text-gray-900">Quote Preview</h2>
                <button (click)="closePreview()"
                    class="text-gray-400 hover:text-gray-600 transition-colors p-2 hover:bg-gray-100 rounded-full">
                    <span class="material-icons-outlined text-2xl">close</span>
                </button>
            </div>

            <!-- Quote Document Content -->
            <div class="px-8 py-6" *ngIf="previewData">
                <!-- Top Section: Account Name (Left) and Quote Number (Right) -->
                <div class="flex justify-between items-start mb-6 pb-4 border-b-2 border-blue-600">
                    <!-- Left: Account Name -->
                    <div>
                        <h1 class="text-3xl font-bold text-blue-600 mb-2">{{ previewData.Account?.Name || 'Account Name'
                            }}
                        </h1>
                        <p class="text-sm text-gray-600">Salesforce Trailhead Org</p>
                        <p class="text-sm text-gray-600">San Francisco, CA 94105</p>
                        <p class="text-sm text-gray-600">Phone:</p>
                        <p class="text-sm text-gray-600">Email:</p>
                    </div>

                    <!-- Right: Quote Number and Dates -->
                    <div class="text-right">
                        <h2 class="text-2xl font-bold text-blue-600 mb-3">
                            Q-{{ previewData?.QuoteNumber }}
                        </h2>

                        <div class="text-sm space-y-1">
                            <div class="flex justify-between gap-8">
                                <span class="font-semibold">Date:</span>
                                <span>{{ ((startDate || previewData.StartDate) | date:'MM-dd-yyyy') || '-' }}</span>
                            </div>
                            <div class="flex justify-between gap-8">
                                <span class="font-semibold">Expires On:</span>
                                <span>{{ ((expirationDate || previewData.ExpirationDate) | date:'MM-dd-yyyy') || '-'
                                    }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Prepared For and Prepared By Section -->
                <div class="grid grid-cols-2 gap-8 mb-6">
                    <!-- Prepared For -->
                    <div>
                        <h3 class="text-lg font-bold text-gray-900 mb-2">Prepared For:</h3>
                        <p class="text-sm text-gray-700">{{ previewData.Opportunity?.Name || opportunityName ||
                            'Opportunity
                            Name' }}</p>
                        <p class="text-sm text-gray-600">{{ previewData.Account?.Name || accountName || '-' }}</p>
                    </div>

                    <!-- Prepared By -->
                    <div>
                        <h3 class="text-lg font-bold text-gray-900 mb-2">Prepared By:</h3>
                        <p class="text-sm text-gray-700">Sales Representative</p>
                        <p class="text-sm text-gray-600">email&#64;example.com</p>
                    </div>
                </div>

                <!-- Quote Line Items Table -->
                <div class="mb-6">
                    <h3 class="text-xl font-bold text-gray-900 mb-4">Products ({{
                        previewData.QuoteLineItems?.records?.length || 0 }})</h3>
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-blue-500 text-white">
                                <th class="border border-gray-300 px-3 py-2 text-left text-sm font-bold">Qty</th>
                                <th class="border border-gray-300 px-3 py-2 text-left text-sm font-bold">Name</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let item of previewData.QuoteLineItems?.records" class="hover:bg-gray-50">
                                <td class="border border-gray-300 px-3 py-2 text-sm">1.00</td>

                                <td class="border border-gray-300 px-3 py-2 text-sm font-medium">{{ item.Product2?.Name
                                    ||
                                    productName || 'Product' }}</td>
                            </tr>
                            <tr *ngIf="!previewData.QuoteLineItems?.records?.length">
                                <td colspan="3"
                                    class="border border-gray-300 px-3 py-4 text-center text-sm text-gray-500">
                                    No products added to this quote
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Subscription Periods Section (for Looker Subscription Flow) -->
                <div class="mb-6" *ngIf="isLookerSubscription && previewCommitments.length > 0">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-900">Subscription Years ({{ previewCommitments.length
                            }})
                        </h3>
                    </div>

                    <!-- New Table Structure -->
                    <div *ngFor="let period of previewCommitments; let i = index" class="mb-8">
                        <h4
                            class="text-lg font-bold text-gray-800 mb-4 bg-gray-50 p-2 rounded-lg border border-gray-200">
                            {{ period.name }}
                            <span class="text-sm font-normal text-gray-600 ml-2">({{ period.startDate }} - {{
                                period.endDate }})</span>
                        </h4>

                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse border border-gray-300">
                                <thead>
                                    <tr class="bg-[#1a73e8] text-white">
                                        <th
                                            class="border border-gray-300 px-3 py-3 text-left text-xs font-bold uppercase tracking-wider">
                                            Product Name</th>
                                        <th
                                            class="border border-gray-300 px-3 py-3 text-left text-xs font-bold uppercase tracking-wider">
                                            Operation Type</th>
                                        <th
                                            class="border border-gray-300 px-3 py-3 text-center text-xs font-bold uppercase tracking-wider">
                                            Quantity</th>
                                        <th
                                            class="border border-gray-300 px-3 py-3 text-left text-xs font-bold uppercase tracking-wider">
                                            Service Start Date</th>
                                        <th
                                            class="border border-gray-300 px-3 py-3 text-left text-xs font-bold uppercase tracking-wider min-w-[100px]">
                                            Order Term (Months)</th>
                                        <th
                                            class="border border-gray-300 px-3 py-3 text-right text-xs font-bold uppercase tracking-wider">
                                            List Price (USD)</th>
                                        <th
                                            class="border border-gray-300 px-3 py-3 text-right text-xs font-bold uppercase tracking-wider">
                                            Discount (%)</th>
                                        <th
                                            class="border border-gray-300 px-3 py-3 text-right text-xs font-bold uppercase tracking-wider">
                                            Total Subscription Fees (USD)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr *ngFor="let item of period.items" class="hover:bg-gray-50 text-gray-700">
                                        <td class="border border-gray-300 px-3 py-2 text-sm">
                                            {{ item.name }}
                                        </td>
                                        <td class="border border-gray-300 px-3 py-2 text-sm">{{ item.operationType }}
                                        </td>
                                        <td class="border border-gray-300 px-3 py-2 text-sm text-center">{{
                                            item.quantity }}</td>
                                        <td class="border border-gray-300 px-3 py-2 text-sm">{{ item.startDate }}</td>
                                        <td class="border border-gray-300 px-3 py-2 text-sm">{{ item.orderTerm }}</td>
                                        <td
                                            class="border border-gray-300 px-3 py-2 text-sm text-right whitespace-nowrap">
                                            {{ formatCurrency(item.listPrice) }}</td>
                                        <td class="border border-gray-300 px-3 py-2 text-sm text-right">{{ item.discount
                                            }}%</td>
                                        <td
                                            class="border border-gray-300 px-3 py-2 text-sm text-right font-medium whitespace-nowrap">
                                            {{ formatCurrency(item.total) }}</td>
                                    </tr>
                                    <tr *ngIf="!period.items || period.items.length === 0">
                                        <td colspan="8"
                                            class="border border-gray-300 px-3 py-4 text-center text-sm text-gray-500">
                                            No items in this period.
                                        </td>
                                    </tr>
                                    <!-- Period Total Row -->
                                    <tr class="bg-gray-100 font-bold text-gray-900 border-t-2 border-gray-300">
                                        <td colspan="7" class="border border-gray-300 px-3 py-2 text-sm text-right">
                                            Period Total (USD):</td>
                                        <td class="border border-gray-300 px-3 py-2 text-sm text-right">{{
                                            formatCurrency(period.amount) }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>


                <!-- Commitment Details Section -->
                <div class="mb-6" *ngIf="!isLookerSubscription">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-900">Commitment Details ({{ previewCommitments.length }})
                        </h3>
                    </div>

                    <!-- Commitments Table -->
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-blue-500 text-white">
                                <th class="border border-gray-300 px-3 py-2 text-left text-sm font-bold">Line name</th>
                                <th class="border border-gray-300 px-3 py-2 text-left text-sm font-bold">Commitments
                                </th>
                                <th class="border border-gray-300 px-3 py-2 text-left text-sm font-bold">Start date</th>
                                <th class="border border-gray-300 px-3 py-2 text-left text-sm font-bold">End date</th>
                                <th class="border border-gray-300 px-3 py-2 text-center text-sm font-bold">Period</th>
                                <th class="border border-gray-300 px-3 py-2 text-right text-sm font-bold">Commitment
                                    value
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let commitment of previewCommitments; let i = index" class="hover:bg-gray-50">
                                <td class="border border-gray-300 px-3 py-2 text-sm text-center">{{ i + 1 }}</td>
                                <td class="border border-gray-300 px-3 py-2 text-sm font-medium">{{ commitment.name }}
                                </td>
                                <td class="border border-gray-300 px-3 py-2 text-sm">{{ commitment.startDate }}</td>
                                <td class="border border-gray-300 px-3 py-2 text-sm">{{ commitment.endDate }}</td>
                                <td class="border border-gray-300 px-3 py-2 text-sm text-center">{{ commitment.months }}
                                </td>
                                <td class="border border-gray-300 px-3 py-2 text-sm text-right">{{
                                    formatCurrency(commitment.amount) }}</td>
                            </tr>
                            <tr *ngIf="previewCommitments.length === 0">
                                <td colspan="6"
                                    class="border border-gray-300 px-3 py-4 text-center text-sm text-gray-500">
                                    No commitment periods defined
                                </td>
                            </tr>
                            <!-- Total Row -->
                            <tr class="bg-gray-100 font-bold">
                                <td colspan="4" class="border border-gray-300 px-3 py-2 text-sm text-right">TOTAL:</td>
                                <td class="border border-gray-300 px-3 py-2 text-sm text-center">{{ totalTerms }}</td>
                                <td class="border border-gray-300 px-3 py-2 text-sm text-right">{{
                                    formatCurrency(totalContractValue) }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Footer Note -->
                <div class="text-xs text-gray-600 mb-4">
                    <p>Please fax a signed copy of this SO and other referenced documents to and mail two sets of
                        originals
                        to:</p>
                    <p class="mt-2">{{ previewData.Account?.Name || accountName || 'Account Name' }}</p>
                    <p>Attn: Sales Contracts</p>
                    <p>Salesforce Org</p>
                    <p>San Francisco, CA 94105</p>
                </div>
            </div>

            <!-- Footer -->
            <div
                class="sticky bottom-0 bg-white border-t border-gray-200 px-8 py-4 rounded-b-2xl flex justify-end gap-3">
                <button (click)="closePreview()"
                    class="px-6 py-2 rounded-full text-sm font-bold bg-blue-600 text-white hover:bg-blue-700 transition-colors shadow-sm">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>